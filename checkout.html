<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - KIWI Telecom</title>
  <link rel="stylesheet" href="src/output.css" />
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <a href="index.html" class="text-xl font-bold text-blue-600">KIWI Telecom</a>
      <img src="images/logo.png" alt="Logo" class="h-12" />
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold mb-6">Checkout</h1>

    <div id="emptyState" class="hidden text-center py-16 bg-white rounded-xl shadow">
      <p class="text-gray-600 mb-4">Your cart is empty.</p>
      <a href="index.html" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Continue Shopping</a>
    </div>

    <div id="cartWrapper" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Items -->
      <div class="lg:col-span-2 bg-white rounded-xl shadow p-4" id="itemsContainer"></div>

      <!-- Summary -->
      <aside class="bg-white rounded-xl shadow p-4 h-fit" id="summary">
        <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
        <div class="flex justify-between text-gray-700 mb-2">
          <span>Subtotal</span>
          <span id="subtotal">₹0</span>
        </div>
        <div class="flex justify-between text-gray-700 mb-2">
          <span>Shipping</span>
          <span id="shipping">₹0</span>
        </div>
        <div class="border-t my-3"></div>
        <div class="flex justify-between font-semibold text-lg">
          <span>Total</span>
          <span id="total">₹0</span>
        </div>
        <button id="placeOrder" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium">Place Order</button>
        <button id="clearCart" class="w-full mt-2 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg font-medium">Clear Cart</button>
      </aside>
    </div>
  </main>

  <!-- Order Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Enter your details</h3>
        <button id="closeOrderModal" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">×</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-700 mb-1">Name</label>
          <input id="custName" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="Your full name" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">Mobile Number</label>
          <input id="custMobile" type="tel" maxlength="15" class="w-full border rounded-lg px-3 py-2" placeholder="10-digit mobile number" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">Address</label>
          <textarea id="custAddress" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="House, Street, City, Pincode"></textarea>
        </div>
      </div>
      <div class="mt-6 flex gap-3">
        <button id="submitOrder" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium">Confirm Order</button>
        <button id="cancelOrder" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg font-medium">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Success Popup -->
  <div id="successPopup" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center">
      <div class="mx-auto mb-4 h-16 w-16 rounded-full bg-green-100 flex items-center justify-center">
        <svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h3 class="text-xl font-bold">Order Placed!</h3>
      <p class="mt-1 text-gray-600">Thank you for shopping with us.</p>
      <button id="successOk" class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">OK</button>
    </div>
  </div>

  <script>
    function parsePrice(p) {
      // prices come like "₹1299"; strip non-digits
      const n = String(p || '').replace(/[^0-9.]/g, '');
      return Number(n || 0);
    }

    function formatINR(n) {
      return '₹' + new Intl.NumberFormat('en-IN').format(Math.round(n));
    }

    function loadCart() {
      try {
        return JSON.parse(localStorage.getItem('cart') || '[]');
      } catch { return []; }
    }

    function saveCart(cart) {
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    function render() {
      const cart = loadCart();
      const empty = document.getElementById('emptyState');
      const wrapper = document.getElementById('cartWrapper');
      const itemsContainer = document.getElementById('itemsContainer');
      const subtotalEl = document.getElementById('subtotal');
      const totalEl = document.getElementById('total');
      const shippingEl = document.getElementById('shipping');

      if (!cart.length) {
        empty.classList.remove('hidden');
        wrapper.classList.add('hidden');
        return;
      }
      empty.classList.add('hidden');
      wrapper.classList.remove('hidden');

      let subtotal = 0;
      itemsContainer.innerHTML = cart.map((item, idx) => {
        const price = parsePrice(item.price);
        subtotal += price * (item.qty || 1);
        return `
          <div class="flex gap-4 border-b py-4 last:border-b-0">
            <img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-contain bg-white rounded" />
            <div class="flex-1">
              <div class="flex justify-between">
                <h3 class="font-semibold">${item.name}</h3>
                <button data-remove="${idx}" class="text-red-600 hover:underline">Remove</button>
              </div>
              <p class="text-sm text-gray-600">Category: ${item.category}</p>
              <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3 items-center">
                <div>
                  <label class="block text-xs text-gray-500 mb-1">Price</label>
                  <span class="font-semibold">${item.price}</span>
                </div>
                <div>
                  <label class="block text-xs text-gray-500 mb-1">Quantity</label>
                  <div class="flex items-center gap-2">
                    <button data-dec="${idx}" class="px-2 py-1 border rounded">-</button>
                    <input data-qty="${idx}" type="number" min="1" value="${item.qty || 1}"
                           class="w-16 border rounded px-2 py-1 text-sm text-center" />
                    <button data-inc="${idx}" class="px-2 py-1 border rounded">+</button>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
      }).join('');

      const shipping = 0; // free shipping
      const total = subtotal + shipping;
      subtotalEl.textContent = formatINR(subtotal);
      shippingEl.textContent = formatINR(shipping);
      totalEl.textContent = formatINR(total);

      // Wire buttons
      itemsContainer.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.getAttribute('data-remove'));
          const c = loadCart(); c.splice(i, 1); saveCart(c); render();
        });
      });
      itemsContainer.querySelectorAll('[data-inc]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.getAttribute('data-inc'));
          const c = loadCart(); c[i].qty = (c[i].qty || 1) + 1; saveCart(c); render();
        });
      });
      itemsContainer.querySelectorAll('[data-dec]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.getAttribute('data-dec'));
          const c = loadCart(); c[i].qty = Math.max(1, (c[i].qty || 1) - 1); saveCart(c); render();
        });
      });
      // Wire quantity input
      itemsContainer.querySelectorAll('[data-qty]').forEach(input => {
        input.addEventListener('change', () => {
          const i = Number(input.getAttribute('data-qty'));
          let v = parseInt(input.value || '1', 10);
          if (!Number.isFinite(v) || v < 1) v = 1;
          const c = loadCart(); c[i].qty = v; saveCart(c); render();
        });
      });
      // No CPP inputs on checkout; only qty is editable
    }

    const orderModal = document.getElementById('orderModal');
    const successPopup = document.getElementById('successPopup');
    const placeOrderBtn = document.getElementById('placeOrder');
    const closeOrderModal = document.getElementById('closeOrderModal');
    const cancelOrder = document.getElementById('cancelOrder');
    const submitOrder = document.getElementById('submitOrder');
    const successOk = document.getElementById('successOk');

    // Configure your Google Apps Script Web App URL here

    const APPS_SCRIPT_URL = window.APPS_SCRIPT_URL || 'https://script.google.com/macros/s/AKfycbyTsXL8VMzH9rsamp1LP0ra8sP4fffGTiqXhOGjvqrS1TA_0cA-8VDYQ2hMpdfSQXSD/exec';

    function openOrderModal() {
      orderModal.classList.remove('hidden');
      orderModal.classList.add('flex');
      document.getElementById('custName').focus();
    }
    function closeModal() {
      orderModal.classList.add('hidden');
      orderModal.classList.remove('flex');
    }
    function openSuccess() {
      successPopup.classList.remove('hidden');
      successPopup.classList.add('flex');
    }
    function closeSuccess() {
      successPopup.classList.add('hidden');
      successPopup.classList.remove('flex');
    }

    placeOrderBtn.addEventListener('click', () => {
      const cart = loadCart();
      if (!cart.length) return;
      openOrderModal();
    });
    closeOrderModal.addEventListener('click', closeModal);
    cancelOrder.addEventListener('click', closeModal);

    async function postToAppsScript(payload) {
      // Attempt normal JSON POST first
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000);
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal,
          credentials: 'omit'
        });
        clearTimeout(timeout);
        let bodyText = '';
        try { bodyText = await res.text(); } catch {}
        let parsed = null;
        try { parsed = JSON.parse(bodyText); } catch {}
        const ok = res.ok && (parsed?.ok !== false);
        return { ok, status: res.status, bodyText, parsed };
      } catch (e) {
        console.warn('Normal POST failed (likely CORS). Retrying with no-cors...', e);
      }

      // Fallback for CORS: no-cors + text/plain (cannot read response, assume success)
      try {
        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload),
          credentials: 'omit'
        });
        return { ok: true, status: 0, bodyText: '', parsed: null };
      } catch (e2) {
        console.error('Apps Script POST failed (no-cors fallback):', e2);
        return { ok: false, status: 0, bodyText: String(e2), parsed: null };
      }
    }

    submitOrder.addEventListener('click', async () => {
      const name = (document.getElementById('custName').value || '').trim();
      const mobile = (document.getElementById('custMobile').value || '').trim();
      const address = (document.getElementById('custAddress').value || '').trim();
      const mobileOk = /^\+?[0-9\s-]{10,15}$/.test(mobile.replace(/\s|-/g, '')) && mobile.replace(/\D/g,'').length >= 10;
      if (!name || !mobileOk || !address) {
        alert('Please enter your Name, valid Mobile number, and Address.');
        return;
      }

      const cart = loadCart();
      if (!cart.length) { closeModal(); return; }

      // Build payload
      // Date-only (no time) for Sheets
      const dateOnly = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      const shipping = 0;
      const subtotal = cart.reduce((s, it) => s + parsePrice(it.price) * (it.qty || 1), 0);
      const total = subtotal + shipping;
      const items = cart.map(it => ({
        name: it.name,
        category: it.category,
        price: parsePrice(it.price),
        qty: it.qty || 1
      }));

      // New flat rows for Google Sheets (each item one row)
      // Columns (exact labels as requested):
      // Date, Name, Address, Mobile Number, Item Name, Catergory, Unit Price, Quantity, Order Total
      const rowsV2 = cart.map(it => [
        dateOnly,
        name.toUpperCase(),
        address.toUpperCase(),
        mobile.toUpperCase(),
        it.name, // keep product name as-is (case preserved)
        (it.category || '').toUpperCase(),
        parsePrice(it.price),
        (it.qty || 1),
        total
      ]);
      const columnsV2 = ['Date','Name','Address','Mobile Number','Item Name','Catergory','Unit Price','Quantity','Order Total'];

      // Keep old structure for backward compatibility, but include new fields preferred for Sheets
      const payload = { 
        date: dateOnly, // previously ISO; now date-only
        name, mobile, address, subtotal, shipping, total, items,
        format: 'flat_v2',
        columnsV2,
        rowsV2
      };

      // Disable actions while sending
      submitOrder.disabled = true; submitOrder.textContent = 'Placing...';
      cancelOrder.disabled = true; closeOrderModal.disabled = true;

      let result = { ok: true, status: 0, bodyText: '', parsed: null };
      if (APPS_SCRIPT_URL) {
        result = await postToAppsScript(payload);
      }

      // Re-enable buttons
      submitOrder.disabled = false; submitOrder.textContent = 'Confirm Order';
      cancelOrder.disabled = false; closeOrderModal.disabled = false;

      if (!result.ok) {
        console.error('Order POST error:', result);
        alert(`Failed to send order to Google Sheets.\nStatus: ${result.status}\nResponse: ${result.bodyText || 'No body'}\nYour order is NOT lost. Please try again.`);
        return; // keep modal open and cart intact
      }

      // Success UX
      closeModal();
      openSuccess();
      // Clear cart
      saveCart([]);
    });

    successOk.addEventListener('click', () => {
      closeSuccess();
      window.location.href = 'index.html';
    });

    document.getElementById('clearCart').addEventListener('click', () => {
      saveCart([]);
      render();
    });

    // init
    render();
    // If navigated with openOrder=1 and cart has items, open modal automatically
    try {
      const params = new URLSearchParams(window.location.search || '');
      if (params.get('openOrder') === '1') {
        const c = loadCart();
        if (c && c.length) {
          openOrderModal();
        }
      }
    } catch {}
  </script>
</body>
</html>
